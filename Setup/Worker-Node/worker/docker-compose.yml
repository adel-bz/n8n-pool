services:
  n8n-worker-1:
    # First queue worker; points to master DB/Redis
    image: n8nio/n8n:1.121.3
    restart: always
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=192.168.1.2 # IP of the master node
      - DB_POSTGRESDB_PORT=5433
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_NON_ROOT_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=192.168.1.2 # IP of the master node
      - QUEUE_BULL_REDIS_PORT=6380
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      - N8N_ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_CONCURRENCY_PRODUCTION_LIMIT=15
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_TEMPLATES_ENABLED=false
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      - N8N_RUNNERS_AUTH_TOKEN=${RUNNERS_TOKEN} # must match master and runners
    command: worker

    networks:
      n8n-worker:
        ipv4_address: 172.110.0.101

  n8n-worker-2:
    # Second queue worker; identical to worker-1
    image: n8nio/n8n:1.121.3
    restart: always
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=192.168.1.2 # IP of the master node
      - DB_POSTGRESDB_PORT=5433
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_NON_ROOT_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=192.168.1.2 # IP of the master node
      - QUEUE_BULL_REDIS_PORT=6380
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      - N8N_ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_CONCURRENCY_PRODUCTION_LIMIT=15
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_TEMPLATES_ENABLED=false
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      - N8N_RUNNERS_AUTH_TOKEN=${RUNNERS_TOKEN}
    command: worker

    networks:
      n8n-worker:
        ipv4_address: 172.110.0.102

  n8n-runners-1:
    # Runner attached to worker-1
    image: n8nio/runners:1.121.3
    restart: always
    depends_on:
      - n8n-worker-1
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://172.110.0.101:5679
      - N8N_RUNNERS_AUTH_TOKEN=${RUNNERS_TOKEN}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=15
    networks:
      n8n-worker:
        ipv4_address: 172.110.0.103

  n8n-runners-2:
    # Runner attached to worker-2
    image: n8nio/runners:1.121.3
    restart: always
    depends_on:
      - n8n-worker-2
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://172.110.0.102:5679
      - N8N_RUNNERS_AUTH_TOKEN=${RUNNERS_TOKEN}
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=15
    networks:
      n8n-worker:
        ipv4_address: 172.110.0.104


networks:
  n8n-worker:
    name: n8n-worker
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.110.0.0/24 # align with master subnet and adjust if it conflicts locally
